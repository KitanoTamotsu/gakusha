## 　　Lesson33.スクリプトフィルターを2段階で使う

[サンプル動画] (https://user-images.githubusercontent.com/40127279/134765044-abc39647-2984-4acf-b38d-cf58983c32cc.mp4)
<br>1.alfredに"gakusha"と入力すると、雑学のカテゴリが9つ表示されます
<br>2.入力した最後の文字"a"を削除して、再度入力すると、先ほどとは別のカテゴリが
<br>　表示されます（ランダムに表示させていることのサンプルです）
<br>3.カテゴリを選択すると関連する雑学記事のタイトルを9つ表示します
<br>4.記事を選択するとブラウザでひらきます

#### 開発メモ
ワークフロー
<br>　<img width="600" src="https://user-images.githubusercontent.com/40127279/134764902-0f1c823e-43cb-4fb9-a229-f2c0433d849c.png">

### 1.Gaku-Shaを知ろう
　雑学サイトGaku-Sha
<br>　トップページには最近の記事が表示されています。かなりの頻度で更新していますね
<br>　右側にカテゴリがあり、記事数が表示されています。クリックしてみるとトップページ
<br>　同様の記事の一覧です。1ページ24件。使えそうですね
<br>　カテゴリ同様に目的別というインデックスもあります。ただ人気の記事はタブ切り替え
<br>　で、たった5件なので扱いにくいかな
<br>　
<br>　Alfredにするなら、はじめにカテゴリ・目的別のインデックスから範囲を選んで
<br>　次にランダムに表示させることができそうです

### 2.フローの構成
　そこで、今回は、2段階のScriptFilterにしてみました
<br>　はじめはトップページの左側のカテゴリと目的別を抽出しましょう
<br>　件数の表示が独特な部分から当たりをつけると、すぐにSpan class="count"を発見
<br>　grepとsedで切り取ります
<br>　いつもはtitleやurlといった要素ごとに配列化しますが、今回は一つの配列としました
<br>　sedの出力を\1 \3 \2というように、ブランクで区切って、配列に代入しています
<br>　この部分は簡単なのですが、JSONを作成するときに配列の数字だらけで見難いかな
<br>　
<br>　単なる気まぐれですが、titleに記事数を括弧でつけました。また、argはURLと記事数を
<br>　"_"で繋いでいます。こちらは気まぐれではなく、後続で利用します
<br>　
<br>　あと、JSONの出力をスクロールさせたくなかったので9行としています
<br>　そのためshufとheadでランダムに選択しています
<br>　
<br>　<img width="600" src="https://user-images.githubusercontent.com/40127279/134764943-ffc2a099-7a58-4ec6-ae91-716c05789f1d.png">
<br>　
### 3.2段目のScriptFilter
　2段目のScriptFilterはカテゴリ内のページをランダムで選択。
<br>　そのページにある記事（基本的に24個）から9件をランダムに選んでJSONフォーマットで
<br>　出力します。
<br>　まずは、受け渡ってくるURLと記事数を分離させます。そして記事数によってページの
<br>　URLを生成します。1ページ目の場合は受け渡しURLのまま、2ページ移行はそのURLの
<br>　後に/page/nを追加します。もともと24件未満で1ページになってしまう場合と
<br>　複数ページから選択して、たまたま1ページを選択する場合があるので、ロジックが
<br>　エレガントでないのですね。。。
<br>　
<br>　ページのURLが決まったらcURLでソースを取得して、記事のタイトルとURLを
<br>　配列に格納。あとは9件を選択してJSONにするだけ
<br>　
<br>　<img width="600" src="https://user-images.githubusercontent.com/40127279/134764969-f9d6bec7-ae92-4e18-b50e-cc670284836a.png">
<br>　
#### 背景
　しばらくワークフローを作っていなかったのですが、鈍らないようにと作成してみました　
<br>　雑学をランダム表示させようと思いサーフィンしていたらGaku-Sha.comを見つけました
<br>　2000を超える雑学で、1つが数百字程度となかなか手頃
<br>　URLには数字を使っていないので、カテゴリを解析しながら、ランダム表示です 　

#### 取扱説明
### 機能:
　Gaku-Sha.comサイトの雑学をランダムに表示する
### インストール:
　1.[alfredworkflow](https://github.com/KitanoTamotsu/gakusha/releases/download/1.0/Gaku-Sha.com.alfredworkflow.zip)をダウンロード 
<br>　2.ファイルをダブルクリックしてワークフローに登録

### 使い方:
　Alfredからキーワード『gakusha』で起動
<br>
<br>
[トップページに戻る](https://kitanotamotsu.github.io/)

